<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Lucratividade MEXC - Via Proxy</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .instance { border: 1px solid #00c087; padding: 15px; margin-bottom: 20px; border-radius: 6px; background-color: #e6fff5; }
        input[type="number"], select, button, input[type="text"] { padding: 10px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { cursor: pointer; background-color: #00c087; color: white; border: none; transition: background-color 0.3s; }
        button:hover { background-color: #00996b; }
        .profit { font-weight: bold; margin-top: 10px; font-size: 1.2em; }
        .positive { color: green; }
        .negative { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>游릭 Rastreador de Posi칞칫es MEXC</h1>
        <p>Ajustado para contornar o erro CORS usando um proxy no Vercel/Netlify.</p>
        <button onclick="addInstance()">Adicionar Novo Par</button>
        <hr>
        <div id="instances-container">
            </div>
    </div>

    <script>
        let instanceCount = 0;
        // 游뚿 MUDAN칂A PRINCIPAL: O frontend agora chama o seu pr칩prio dom칤nio (proxy)
        // O proxy ir치 interceptar essa chamada e envi치-la para a API da MEXC.
        const PROXY_BASE_URL = "/api-mexc-proxy/v2/market/ticker"; 
        // O prefixo '/api-mexc-proxy' ser치 configurado no vercel.json

        /**
         * Adiciona uma nova inst칙ncia de rastreamento ao DOM.
         */
        function addInstance() {
            instanceCount++;
            const container = document.getElementById('instances-container');
            const instanceDiv = document.createElement('div');
            instanceDiv.className = 'instance';
            instanceDiv.id = `instance-${instanceCount}`;
            instanceDiv.innerHTML = `
                <h3>Posi칞칚o #${instanceCount}</h3>
                
                <label for="pair-symbol-${instanceCount}">Par de Moedas (ex: BTCUSDT ou CAKEUSDT):</label>
                <input type="text" id="pair-symbol-${instanceCount}" placeholder="Ex: BTCUSDT" size="20" style="text-transform: uppercase;">
                <br><br>
                
                <label for="initial-price-${instanceCount}">Pre칞o Inicial:</label>
                <input type="number" id="initial-price-${instanceCount}" placeholder="0.00" step="any" min="0">
                <br><br>
                
                <label for="operation-type-${instanceCount}">Tipo de Opera칞칚o:</label>
                <select id="operation-type-${instanceCount}">
                    <option value="buy">Compra (Long)</option>
                    <option value="sell">Venda (Short)</option>
                </select>
                <br><br>
                
                <button onclick="startTracking(${instanceCount})">Iniciar Rastreamento</button>
                <button onclick="removeInstance(${instanceCount})" style="background-color: #dc3545;">Remover</button>
                
                <p>Pre칞o Atual: <span id="current-price-${instanceCount}">Aguardando...</span></p>
                <p class="profit">Lucratividade (In Momentum): <span id="profit-value-${instanceCount}">0.00%</span></p>
            `;
            container.appendChild(instanceDiv);
        }

        /**
         * Inicia o rastreamento peri칩dico de pre칞o via API da MEXC para uma inst칙ncia.
         * @param {number} id - ID da inst칙ncia.
         */
        function startTracking(id) {
            const pairSymbolInput = document.getElementById(`pair-symbol-${id}`);
            const initialPriceInput = document.getElementById(`initial-price-${id}`);
            const operationType = document.getElementById(`operation-type-${id}`).value;
            const currentPriceSpan = document.getElementById(`current-price-${id}`);
            const profitValueSpan = document.getElementById(`profit-value-${id}`);
            
            // Tratamento do S칤mbolo: Garante MAI칔SCULAS e remove caracteres inv치lidos
            let symbolInput = pairSymbolInput.value.toUpperCase().trim();
            symbolInput = symbolInput.replace(/[^A-Z]/g, ''); 
            
            // Formata칞칚o para o V2 (Ex: CAKEUSDT -> CAKE_USDT)
            const symbol = symbolInput.replace(/(USDT|USDC|BTC|ETH)$/, `_$&`);
            
            const initialPrice = parseFloat(initialPriceInput.value);

            if (!symbolInput || isNaN(initialPrice) || initialPrice <= 0) {
                alert('Por favor, insira um par v치lido e um pre칞o inicial positivo.');
                return;
            }

            if (window[`interval-${id}`]) {
                clearInterval(window[`interval-${id}`]);
            }

            const updatePrice = async () => {
                try {
                    // Chamada para a URL do Proxy configurada no Vercel/Netlify
                    const response = await axios.get(PROXY_BASE_URL, {
                        params: {
                            symbol: symbol // O par de moedas formatado (ex: CAKE_USDT)
                        }
                    });

                    // Extra칞칚o do pre칞o da resposta do MEXC V2
                    const data = response.data.data;
                    
                    if (!data || data.length === 0 || !data[0].last) {
                        throw new Error("Resposta da API inv치lida ou par n칚o encontrado.");
                    }
                    
                    const currentPrice = parseFloat(data[0].last);
                    
                    // --- C치lculo da Lucratividade ---
                    let percentageProfit;
                    
                    if (operationType === 'buy') {
                        percentageProfit = ((currentPrice - initialPrice) / initialPrice) * 100;
                    } else if (operationType === 'sell') {
                        percentageProfit = ((initialPrice - currentPrice) / initialPrice) * 100;
                    } else {
                        percentageProfit = 0;
                    }

                    // --- Atualiza칞칚o da UI ---
                    const currencySymbol = symbol.includes('USDT') ? '$' : '';
                    
                    currentPriceSpan.textContent = `${currencySymbol}${currentPrice.toFixed(8)}`; 
                    profitValueSpan.textContent = `${percentageProfit.toFixed(2)}%`;
                    
                    profitValueSpan.className = percentageProfit >= 0 ? 'positive' : 'negative';

                } catch (error) {
                    // O erro de rede (CORS) deve parar aqui, se a requisi칞칚o do proxy falhar, a mensagem 칠 exibida
                    console.error(`Erro ao buscar pre칞o para ${symbol}:`, error);
                    currentPriceSpan.textContent = 'Erro de Rede/API'; 
                    profitValueSpan.textContent = '0.00%';
                    profitValueSpan.className = '';
                }
            };
            
            updatePrice(); 
            window[`interval-${id}`] = setInterval(updatePrice, 10000); 
            
            alert(`Rastreamento para ${symbol} iniciado!`);
        }

        /**
         * Remove uma inst칙ncia e seu rastreamento.
         */
        function removeInstance(id) {
            clearInterval(window[`interval-${id}`]); // Para o rastreamento
            const instanceDiv = document.getElementById(`instance-${id}`);
            if (instanceDiv) {
                instanceDiv.remove();
            }
        }

        document.addEventListener('DOMContentLoaded', addInstance);
    </script>
</body>
</html>